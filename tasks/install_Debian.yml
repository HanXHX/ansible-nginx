---

- name: APT | Update cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  changed_when: false

- name: APT | Force OpenSSL from backports (fix dependency break)
  apt:
    pkg: openssl
    state: latest
    default_release: "{{ ansible_distribution_release + '-backports' }}"
  when: nginx_backports

- name: APT | Install nginx and dependencies
  apt:
    pkg: "{{ nginx_apt_package }}"
    state: present
    default_release: "{{ ansible_distribution_release + '-backports' if nginx_backports else ansible_distribution_release }}"

- name: APT | Install nginx modules
  apt:
    pkg: "{{ nginx_module_packages }}"
    state: present

- name: APT | Install python-passlib
  apt:
    pkg: python-passlib
    state: present

- name: STAT | Check acme.sh is installed
  stat:
    path: "{{ nginx_acmesh_dir }}"
  register: acme

- block:

  - name: APT | Install git
    apt:
      pkg: git

  - name: GIT | Get acme.sh
    git:
      repo: 'https://github.com/Neilpang/acme.sh.git'
      dest: '{{ nginx_acmesh_git_dir }}'
      update: no

  - name: SHELL | Install acme.sh
    shell: ./acme.sh --install --home {{ nginx_acmesh_dir }} --cert-home {{ nginx_acmesh_dir }}
    args:
      chdir: "{{ nginx_acmesh_git_dir }}"
      creates: "{{ nginx_acmesh_dir }}"

  when: not acme.stat.exists
